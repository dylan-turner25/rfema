---
# output: github_document

output:
  github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
library(knitr)
library(dplyr)
```

## rfema (R FEMA)

![R-CMD-check](https://github.com/ropensci/ijtiff/workflows/R-CMD-check/badge.svg)
[![Project Status: WIP – Initial development is in progress, but there has not yet been a stable, usable release suitable for the public.](https://www.repostatus.org/badges/latest/wip.svg)](https://www.repostatus.org/)
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html)
[![Codecov test coverage](https://codecov.io/gh/dylan-turner25/rfema/branch/main/graph/badge.svg)](https://codecov.io/gh/dylan-turner25/rfema?branch=main)

<!-- badges: start -->
  <!-- [![R-CMD-check](https://github.com/dylan-turner25/rfema/workflows/R-CMD-check/badge.svg)](https://github.com/dylan-turner25/rfema/actions) -->
<!-- badges: end -->




## Introduction
`rfema` allows users to access The Federal Emergency Management Agency's (FEMA) publicly available data through the open FEMA API. The package provides a set of functions to easily navigate and access all data sets provided by FEMA, including (but not limited to) data from the National Flood Insurance Program and FEMA's various disaster aid programs.

FEMA data is publicly available at the open FEMA website (https://www.fema.gov/about/openfema/data-sets) and is avaliable for bulk download, however, the files are sometimes very large (multiple gigabytes) and many times users do not need all records for a data series (for example: many users may only want records for a single state for several years). Using FEMA's API is a good option to circumvent working with the bulk data files, but can be inaccessible for those without prior API experience. This package contains a set of functions that allows users to easily identify and retrieve data from FEMA's API without needing any technical knowledge of APIs.

In accordance with the open_fema terms and conditions: This product uses the Federal Emergency Management Agency’s Open FEMA API, but is not endorsed by FEMA. The Federal Government or FEMA cannot vouch for the data or analyses derived from these data after the data have been retrieved from the Agency's website(s). Guidance on FEMA's preffered citation for Open FEMA data can be found at: https://www.fema.gov/about/openfema/terms-conditions

## Why rfema?
What are the advantages of accessing the FEMA API through the `rfema` package as compared to accessing the API directly? In short, the `rfema` package handles much of the grunt work associated with constructing API queries, dealing with API limits, and applying filters or other parameters. Suppose one wants to obtain data on all of the flood insurance claims in Broward County, FL between 2010 and 2012. The following code obtains that data without the use of the `rfema` package. As you can see it requires many lines of code with significant hardcoding in the url strings. The hardcoding could be avoided, but that would require even more lines of code.
```{r}

# define the url for the appropriate api end point
base_url <- "https://www.fema.gov/api/open/v1/FimaNfipClaims"

# append the base_url to apply filters
filters <- "?$inlinecount=allpages&$top=1000&$filter=(countyCode%20eq%20'12011')%20and%20(yearOfLoss%20ge%20'2010')%20and%20(yearOfLoss%20le%20'2012')"

api_query <- paste0(base_url, filters)

# run a query setting the top_n parameter to 1 to check how many records match the filters
record_check_query <- "https://www.fema.gov/api/open/v1/FimaNfipClaims?$inlinecount=allpages&$top=1&$select=id&$filter=(countyCode%20eq%20'12011')%20and%20(yearOfLoss%20ge%20'2010')%20and%20(yearOfLoss%20le%20'2012')"

# run the api call and determine the number of matching records
result <- httr::GET(record_check_query)
jsonData <- httr::content(result)        
n_records <- jsonData$metadata$count # there are 2119 records meaning we will need three seperate API calls to get all the data


# calculate number of calls neccesary to get all records using the 
# 1000 records/ call max limit defined by FEMA
itterations <- ceiling(n_records / 1000)
  

for(i in seq(from=1, to=itterations, by=1)){
  # As above, if you have filters, specific fields, or are sorting, add that to the base URL 
  #   or make sure it gets concatenated here.
  result <- httr::GET(paste0(api_query,"&$skip=",(i-1) * 1000))
  jsonData <- httr::content(result)         
  
  if(i == 1){
    data <- dplyr::bind_rows(jsonData[[2]])
  } else {
    data <- dplyr::bind_rows(data, dplyr::bind_rows(jsonData[[2]]))
  }
  


}
 
  
# remove the html line breaks from returned data frame (if there are any)  
data <- as.data.frame(lapply(data, function(data) gsub("\n", "", data)))
  



```

Compare the above block of code to the following code which obtains the same data using the `rfema` package. The `rfema` package allowed the same request to be made with two lines of code. Notably, the `open_fema()` function handled checking the number of records and implementation an iterative loop to get around the 1000 records/call limit.
```{r}
# define a list of filters to apply
filterList <- list(countyCode = "= 12011",yearOfLoss = ">= 2010", yearOfLoss = "<= 2012")

# make the API call using the `open_fema` function.
data <- rfema::open_fema(data_set = "fimaNfipClaims",ask_before_call = F, filters = filterList )

```


## Installation
Right now, the best way to install and use the `rfema` package is by installing directly from GitHub using `devtools::install_github("dylan-turner25/rfema", force = TRUE)`. The FEMA API does not require and API key, meaning no further steps need be taken to start using the package



## Avaliable Datasets
To see the all of the data sets avaliable through `rfema`, we can run the `fema_data_sets()` function which calls the FEMA API endpoint: https://www.fema.gov/api/open/v1/DataSets. This returns a data frame containing meta data on the data sets provided through the open FEMA API.

```{r}
data_sets <- fema_data_sets() 
data_sets$description <- paste0(substr(data_sets$description,1,50),"...") # description shortened in this case to make table smaller

kable(head(data_sets)) # only displaying first few data sets
```




## Example Workflow
Once we know what data set we want to access, or perhaps if we want to know more about what data is avaliable in a given data set, we can use the `fema_data_fields()` function to get a look at the available data fields in a given data set by setting the "data_set" parameter to one of the "name" columns in the data frame returned by the `fema_data_sets()` function.

```{r}
df <- fema_data_fields(data_set = "fimaNfipPolicies")
df$Description <- paste0(substr(df$Description,1,50),"...") # description shortened in this case to make table smaller
kable(head(df))
```



The FEMA API limits the number of records that can be returned in a single query to 1000, meaning if we want more observations than that, a loop is necessary to iterate over multiple API calls. The function handles this automatically, but will warn you before iterating by letting you know how many records there are and how many individual API calls it will take to get all the records. At that point you can enter "1" to continue or "0" to abort the operation. As can be seen below, running `open_fema(data_set = "fimaNfipPolicies")` will indicate that there are over 59 million records if we don't apply any filters to the data set which would take many iterations (and a long time) to collect the full data set. 


```{r,echo=FALSE, r,echo=TRUE}
"[1] 59341663 matching records found. At 1000 records per call, it will take 59342 individual API calls to get all matching records. Continue?"
```

Alternatively, we could specify the top_n argument to limit the number of records returned. Specifying top_n greater than 1000 will initiate the same message letting you know how many iterations it will take to get your data. If top_n is less than 1000, the API call will be automatically be carried out. In the case below, we will return the first 10 records from the NFIP Policies data.
```{r}
df <- open_fema(data_set = "fimaNfipPolicies", top_n = 10)
kable(df)
```

If we wanted to limit the columns returned we could do so by passing a character vector of data fields to be included in the returned data frame. Again, the data fields for a given data set can be retrieved using the `fema_data_fields()` function. In this case we will return only the census tract and CRScode columns. As can be seen, an id column is always returned even if the select argument is used. 
```{r}
df <- open_fema(data_set = "fimaNfipPolicies", top_n = 10, select = c("censusTract","crsClassCode"))
kable(df)
```

If we want to limit the rows returned rather than the columns, we can also apply filters by specifying values of the columns to return. If we want to quickly see the set of variables that can be used to filter API queries with, we can use the valid_parameters() function to return a vector containing the variables that are "searchable" for a particular data set. 
```{r}
params <- valid_parameters(data_set = "fimaNfipPolicies")
kable(params)
```

We can see from the above that both censusTract and crsClassCode are both searchable variables. Thus we can specify a list that contains the values of each variable that we want returned in the data frame. Before doing that however, it can be useful to see unique values of those variables in the data set. We can do this by using the parameter_values() function. This function returns the unique values of a variable contained in the first 1000 observations of a data set. Notably, it does not return all unique values, as that would require access to the entire data set, which as we saw above is almost 59 million records. 

```{r}
parameter_values(data_set = "fimaNfipPolicies",data_field = "crsClassCode")
```


We can see from the above that crsClassCode is an integer in the data and there are 9 unique values in the first 1000 observations of the full dataset. Lets go a head a define a filter to limit our results to records with a crsClassCode that is either 5 or 6.
```{r}
my_filters <- list(crsClassCode = c(5,6))

df <- open_fema(data_set = "fimaNfipPolicies", top_n = 10, 
               select = c("censusTract","crsClassCode"), filters = my_filters)
kable(df)


```






## More Examples

### Example: Return the first 100 NFIP claims for Autauga County, AL that happened between 2010 and 2020.
```{r}
df <- open_fema(data_set = "fimaNfipClaims",
                 top_n = 100,
                 filters = list(countyCode = "= 01001",
                                yearOfLoss = ">= 2010",
                                yearOfLoss = "<= 2020"))
```


### Example: Get data on all Hazard Mitigation Grants associated with Hurricanes in Florida.
```{r}
# see which parameter can be used for filtering the Hazard Mitigation Grants data set
valid_parameters("HazardMitigationGrants") 

# check example values for "incidentType"
parameter_values(data_set = "HazardMitigationGrants", data_field = "incidentType") 

# check to see how "state" is formatted
parameter_values(data_set = "HazardMitigationGrants", data_field = "state") 

# construct a list containing filters for Hurricane and Florida
filter_list <- c(incidentType = c("Hurricane"),
                 state = c("Florida")) 

# pass filter_list to the open_fema function to retreieve data.
df <- open_fema(data_set = "HazardMitigationGrants", filters = filter_list, 
               ask_before_call = FALSE)
kable(head(df))
```


### Example: Determine how much money was awarded by FEMA for rental assistance following Hurricane Irma.

Get a dataset description for the `HousingAssistanceRenters` data set to see if this is the right data set for the question
```{r}
# get meta data for the `HousingAssistanceRenters`
ds <- fema_data_sets() %>% filter(name == "HousingAssistanceRenters")

# there are two entries corresponding to two versions of the data set, 
# we want the most recent one
nrow(ds)
ds <- ds %>% filter(version == max(as.numeric(ds$version)))

# now print out the data set description
print(ds$description)

```

See which columns we can filter on to select just Hurricane Irma related grants
```{r}
# see which parameter can be used for filtering the Housing Assistance for Renters 
valid_parameters("HousingAssistanceRenters") 
```

All we have in this data set is the `disasterNumber`. Thus, to filter on a specific disaster we have to load the `FemaWebDisasterDeclarations` data find the disaster number associated with the event we are interested in.
```{r}
# call the disaster declarations
dd <- rfema::open_fema(data_set = "FemaWebDisasterDeclarations", ask_before_call = F)

# filter disaster declarations to those with "hurricane" in the name
hurricanes <- distinct(dd %>% filter(grepl("hurricane",tolower(disasterName))) %>% select(disasterName, disasterNumber))
kable(head(hurricanes))


```

As can be seen, disaster numbers do not uniquely ID an event, since multiple disaster declarations may be declared for the same event, but in different locations. Thus to filter on a particular event, we need to collect all the disaster declaration numbers corresponding to that event. 
```{r}
# get all disaster declarations associated with hurricane irma. 
# notice the use of grepl() which picked up a disaster declaration name 
# that was differnt than all the others.
dd_irma <- hurricanes %>% filter(grepl("irma",tolower(disasterName)))

# get a vector of just the disaster declaration numbers
dd_nums_irma <- dd_irma$disasterNumber

```

Now we are read to filter our API call for the `HousingAssistanceRenters` data set.
```{r}
# construct filter list
filter_list <- list(disasterNumber = dd_nums_irma)


# make the API call to get individual assistance grants awarded to renters for hurricane Irma damages.
assistance_irma <- open_fema(data_set = "HousingAssistanceRenters", filters = filter_list)

```

Check out the returned data
```{r}
# check out the returned data
kable(head(assistance_irma))

```


Now we can answer our origonal question: How much did FEMA awarded for rental assistance following Hurricane Irma?
```{r}
# sum the rentalAmount Column
rent_assistance <- sum(as.numeric(assistance_irma$rentalAmount))

# scale to millions
rent_assistance <- rent_assistance/1000000

print(paste0("$",round(rent_assistance,2)," million was awarded by FEMA for rental assistance following Hurricane Irma"))

```



## Bulk Downloads
In some cases bulk downloading a full data set file may be preferred. In this case, users can use the bulk_dl() command
to download a csv of the full data file and save it to a specified directory.

```{r,cache = T}
bulk_dl("femaRegions") # download a csv file containing all info on FEMA regions
```
